// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// üë§ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ
model User {
  id            Int             @id @default(autoincrement())
  fullName      String
  email         String          @unique
  password      String
  birthDate     DateTime?
  phone         String?
  role          String          @default("user") // "user" –∏–ª–∏ "admin"
  resetToken    String?         @unique
  resetTokenExpires DateTime?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  isActive      Boolean         @default(true)

  // Relations
  payments      Payment[]
  testAccess    TestAccess[]
  results       TestResult[]
}

// üìã –ü—Ä–æ—Ñ–æ—Ä—ñ—î–Ω—Ç–∞—Ü—ñ–π–Ω—ñ —Ç–µ—Å—Ç–∏
model Test {
  id              Int             @id @default(autoincrement())
  title           String
  description     String?
  category        String?
  price           Float?          @default(0)
  duration        Int?            // –≤ —Ö–≤–∏–ª–∏–Ω–∞—Ö
  questionsCount  Int?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Relations
  questions       Question[]
  access          TestAccess[]
  results         TestResult[]
}

// ‚ùì –ü–∏—Ç–∞–Ω–Ω—è –≤ —Ç–µ—Å—Ç–∞—Ö
model Question {
  id              Int             @id @default(autoincrement())
  testId          Int
  text            String
  questionOrder   Int
  createdAt       DateTime        @default(now())

  test            Test            @relation(fields: [testId], references: [id], onDelete: Cascade)

  @@index([testId])
}

// üí∞ –ü–ª–∞—Ç–µ–∂–∏ —á–µ—Ä–µ–∑ LiqPay
model Payment {
  id                    Int             @id @default(autoincrement())
  userId                Int
  orderId               String          @unique
  amount                Float
  currency              String          @default("UAH")
  status                String          @default("pending") // pending, success, failed
  liqpayTransactionId   String?
  description           String?
  createdAt             DateTime        @default(now())
  completedAt           DateTime?
  expiresAt             DateTime?

  user                  User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  testAccess            TestAccess[]

  @@index([userId])
  @@index([orderId])
}

// üîì –î–æ—Å—Ç—É–ø –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –¥–æ —Ç–µ—Å—Ç—ñ–≤
model TestAccess {
  id                    Int             @id @default(autoincrement())
  userId                Int
  testId                Int
  paymentId             Int?
  hasAccess             Boolean         @default(false)
  accessGrantedAt       DateTime?
  accessExpiresAt       DateTime?
  createdAt             DateTime        @default(now())

  user                  User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  test                  Test            @relation(fields: [testId], references: [id], onDelete: Cascade)
  payment               Payment?        @relation(fields: [paymentId], references: [id], onDelete: SetNull)

  @@unique([userId, testId])
  @@index([userId])
  @@index([testId])
}

// üìä –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –ø—Ä–æ–π–¥–µ–Ω–∏—Ö —Ç–µ—Å—Ç—ñ–≤
model TestResult {
  id                    Int             @id @default(autoincrement())
  userId                Int
  testId                Int
  scores                String?         // JSON: {"category": score}
  recommendations       String?         // JSON: —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó –ø—Ä–æ—Ñ–µ—Å—ñ–π
  completedAt           DateTime        @default(now())

  user                  User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  test                  Test            @relation(fields: [testId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([testId])
}

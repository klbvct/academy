# üóÑÔ∏è Prisma ORM ‚Äî –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

–ù–∏–∂–µ –∞–∫—Ç—É–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ —Ä–∞–±–æ—Ç–µ —Å Prisma –≤ –ø—Ä–æ–µ–∫—Ç–µ –∏ –ø–æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–π —Ç–µ–∫—É—â–µ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.

## üìä –ß—Ç–æ –µ—Å—Ç—å –≤ –ø—Ä–æ–µ–∫—Ç–µ

- ‚úÖ `Prisma Client` ‚Äî ORM –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î
- ‚úÖ –õ–æ–∫–∞–ª—å–Ω–∞—è dev-–±–∞–∑–∞ (SQLite) ‚Äî —Ñ–∞–π–ª –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ `prisma/prisma/dev.db`
- ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ ‚Äî –ø–∞–ø–∫–∞ `prisma/migrations` —Å –∏—Å—Ç–æ—Ä–∏–µ–π –∏–∑–º–µ–Ω–µ–Ω–∏–π
- ‚úÖ –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø–æ—Å–µ–≤–∞ `prisma/seed.ts` –∏ –∫–æ–º–∞–Ω–¥–∞ `npm run prisma:seed`

---

## üìã –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü –≤ –ë–î (–ø–æ `schema.prisma`)

### Users (–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏)
```
- id: —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
- fullName: –ø–æ–ª–Ω–æ–µ –∏–º—è
- email: —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞ (—É–Ω–∏–∫–∞–ª—å–Ω–∞—è)
- password: –ø–∞—Ä–æ–ª—å (—Ö–µ—à–∏—Ä—É–µ—Ç—Å—è bcryptjs –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º)
- phone: –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)
- birthDate: –¥–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è
- role: —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ("user" | "admin")
- isActive: —Å—Ç–∞—Ç—É—Å –∞–∫–∫–∞—É–Ω—Ç–∞
- resetToken: —Ç–æ–∫–µ–Ω –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è
- resetTokenExpires: —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è —Ç–æ–∫–µ–Ω–∞ —Å–±—Ä–æ—Å–∞
- createdAt: –¥–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞
- updatedAt: –¥–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
```

### Tests (–¢–µ—Å—Ç—ã)
```
- id: ID —Ç–µ—Å—Ç–∞
- title: –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–∞
- description: –æ–ø–∏—Å–∞–Ω–∏–µ
- category: –∫–∞—Ç–µ–≥–æ—Ä–∏—è
- price: —Ü–µ–Ω–∞ (–¥–ª—è LiqPay)
- duration: –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ –º–∏–Ω—É—Ç–∞—Ö
- questionsCount: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–ø—Ä–æ—Å–æ–≤
```

### Questions (–í–æ–ø—Ä–æ—Å—ã)
```
- id: ID –≤–æ–ø—Ä–æ—Å–∞
- testId: —Å–≤—è–∑—å —Å —Ç–µ—Å—Ç–æ–º
- text: —Ç–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞
- questionOrder: –ø–æ—Ä—è–¥–∫–æ–≤—ã–π –Ω–æ–º–µ—Ä
```

### Payments (–ü–ª–∞—Ç–µ–∂–∏ - –¥–ª—è LiqPay)
```
- id: ID –ø–ª–∞—Ç–µ–∂–∞
- userId: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
- testId: —Ç–µ—Å—Ç
- orderId: —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –∑–∞–∫–∞–∑–∞
- amount: —Å—É–º–º–∞
- currency: –≤–∞–ª—é—Ç–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é "UAH")
- type: —Ç–∏–ø –ø–ª–∞—Ç–µ–∂–∞ ("access" ‚Äî –¥–æ—Å—Ç—É–ø –∫ —Ç–µ—Å—Ç—É, "results" ‚Äî –¥–æ—Å—Ç—É–ø –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º)
- status: —Å—Ç–∞—Ç—É—Å ("pending" | "success" | "failed")
- liqpayTransactionId: ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ LiqPay
- description: –æ–ø–∏—Å–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
- createdAt: –¥–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è
- completedAt: –¥–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
- expiresAt: –¥–∞—Ç–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞
```

### TestAccess (–î–æ—Å—Ç—É–ø –∫ —Ç–µ—Å—Ç–∞–º)
```
- id: ID –¥–æ—Å—Ç—É–ø–∞
- userId: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
- testId: —Ç–µ—Å—Ç
- paymentId: —Å–≤—è–∑—å —Å –ø–ª–∞—Ç–µ–∂–æ–º
- hasAccess: –µ—Å—Ç—å –ª–∏ –¥–æ—Å—Ç—É–ø
- accessGrantedAt: –∫–æ–≥–¥–∞ –≤—ã–¥–∞–Ω –¥–æ—Å—Ç—É–ø
- accessExpiresAt: –∫–æ–≥–¥–∞ –∏—Å—Ç–µ–∫–∞–µ—Ç –¥–æ—Å—Ç—É–ø
```

### TestResult (–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤)
```
- id: ID —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
- userId: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
- testId: —Ç–µ—Å—Ç
- data: –æ—Ç–≤–µ—Ç—ã/–¥–∞–Ω–Ω—ã–µ (—Å—Ç—Ä–æ–∫–∞ —Å JSON)
- scores: —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (JSON —Å—Ç—Ä–æ–∫–∞)
- recommendations: —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (JSON —Å—Ç—Ä–æ–∫–∞)
- completedAt: –∫–æ–≥–¥–∞ –ø—Ä–æ–π–¥–µ–Ω
```

---

## üõ†Ô∏è –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã Prisma

–õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ (—Å–æ–∑–¥–∞–Ω–∏–µ –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏, –æ—Ç–∫—Ä—ã—Ç–∏–µ Studio):

```bash
# –°–æ–∑–¥–∞—Ç—å/–ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –ª–æ–∫–∞–ª—å–Ω–æ
npx prisma migrate dev --name init

# –û—Ç–∫—Ä—ã—Ç—å Prisma Studio (UI)
npx prisma studio
```

–°–±—Ä–æ—Å –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î (–æ—á–∏—Å—Ç–∏—Ç –¥–∞–Ω–Ω—ã–µ –∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç –º–∏–≥—Ä–∞—Ü–∏–∏):

```bash
npx prisma migrate reset
```

–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —É–∂–µ –∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã—Ö –º–∏–≥—Ä–∞—Ü–∏–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (production):

```bash
npx prisma migrate deploy
```

---

## üíª –ü—Ä–∏–º–µ—Ä—ã —Ä–∞–±–æ—Ç—ã —Å Prisma –≤ –∫–æ–¥–µ

### –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
```typescript
import { prisma } from '@/lib/prisma'
import bcrypt from 'bcryptjs'

const hashedPassword = await bcrypt.hash('plaintextPassword', 12)

const user = await prisma.user.create({
  data: {
    fullName: '–Ü–≤–∞–Ω –ü–µ—Ç—Ä–µ–Ω–∫–æ',
    email: 'ivan@example.com',
    phone: '+380501234567',
    password: hashedPassword, // –≤—Å–µ–≥–¥–∞ —Ö–µ—à–∏—Ä—É–π—Ç–µ –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
    birthDate: new Date('2005-01-15'),
  },
})
```

### –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
```typescript
const user = await prisma.user.findUnique({
  where: { email: 'ivan@example.com' },
})
```

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
```typescript
const updatedUser = await prisma.user.update({
  where: { id: 1 },
  data: { fullName: '–ù–æ–≤–æ–µ –∏–º—è' },
})
```

### –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
```typescript
await prisma.user.delete({
  where: { id: 1 },
})
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤:
```typescript
const tests = await prisma.test.findMany({
  include: { questions: true },
})
```

---

## ‚ö†Ô∏è –í–ê–ñ–ù–û –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

1. –•–µ—à–∏—Ä—É–π—Ç–µ –ø–∞—Ä–æ–ª–∏: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `bcryptjs` –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø–∞—Ä–æ–ª–µ–π –≤ –ë–î.

```bash
npm install bcryptjs
```

2. –¢–µ–∫—É—â–µ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç SQLite (—É–¥–æ–±–Ω–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏). –î–ª—è production —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è PostgreSQL ‚Äî –∏–∑–º–µ–Ω–∏—Ç–µ datasource –≤ `prisma/schema.prisma` –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ `DATABASE_URL`.

```env
DATABASE_URL="postgresql://user:password@host:5432/dbname"
```

3. –ù–∞ production –ø—Ä–∏–º–µ–Ω—è–π—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –∫–æ–º–∞–Ω–¥–æ–π `npx prisma migrate deploy` (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `db push` –¥–ª—è production).

4. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤ (—Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∞—è)

```
prisma/
‚îú‚îÄ‚îÄ schema.prisma
‚îú‚îÄ‚îÄ prisma/
‚îÇ   ‚îî‚îÄ‚îÄ dev.db             # –ª–æ–∫–∞–ª—å–Ω–∞—è dev sqlite –ë–î
‚îî‚îÄ‚îÄ migrations/
  ‚îî‚îÄ‚îÄ <timestamp>_init/

lib/
‚îî‚îÄ‚îÄ prisma.ts               # –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Prisma Client

.env                        # –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (DATABASE_URL –∏ —Ç.–¥.)
```

---

## üîÑ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è production

1. –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ—Å—å –Ω–∞ PostgreSQL ‚Äî –∏–∑–º–µ–Ω–∏—Ç–µ `provider` –≤ `prisma/schema.prisma` –∏ –∑–∞–¥–∞–π—Ç–µ `DATABASE_URL` –≤ `.env`.
2. –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ: `npx prisma migrate deploy`.
3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `prisma/migrations` –µ—Å—Ç—å –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ (–Ω–µ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è `.gitignore`).

---

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** —Å–µ–π—á–∞—Å –ø—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ä–µ–∞–ª—å–Ω—É—é –ë–î (SQLite) –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏; –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–µ—Ä–µ–Ω–æ—Å –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—É—é –°–£–ë–î –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π.
